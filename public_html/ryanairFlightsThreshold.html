<html>

	<head>
		<meta charset="UTF-8">
		
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.17.1/moment.min.js"></script>
		
		<script>
			function handleTrip(trip, targetDiv, maxPrice){
				var html = "";
				
				trip.dates.forEach(function(date, index){
					date.flights.forEach(function(flight, index){
						if(flight.regularFare != undefined && flight.regularFare.fares[0].amount <= maxPrice){
							var takeOffTime = moment(flight.time[0]);
							if(takeOffTime.day() == 0 || takeOffTime.day() == 6){
								html += '<tr style="font-weight: bold;">';
							} else {
								html += '<tr>';
							}
							if(flight.faresLeft > 0 || flight.faresLeft == -1){
								var faresLeft = flight.faresLeft > 0 ? '<br />(posti rimasti '+flight.faresLeft+')' : '';
								html += '<td>' + takeOffTime.format('DD/MM/YYYY') + '</td><td>' + takeOffTime.format('HH:mm') + '</td><td>' + moment(flight.time[1]).format('HH:mm') + '</td><td>' + flight.flightNumber + '</td><td style="text-align: right;">€ ' + Number((flight.regularFare.fares[0].amount * 1.022).toFixed(2)) + faresLeft + '</td><td style="text-align: right;">€ ' + Number((flight.leisureFare.fares[0].amount * 1.022).toFixed(2)) + '</td><td style="text-align: right;">€ ' + Number((flight.businessFare.fares[0].amount * 1.022).toFixed(2)) + '</td></tr>';
							} else {
								html += '<td>' + takeOffTime.format('DD/MM/YYYY') + '</td><td>' + takeOffTime.format('HH:mm') + '</td><td>' + moment(flight.time[1]).format('HH:mm') + '</td><td>' + flight.flightNumber + '</td><td style="text-align: center;">-</td><td style="text-align: center;">-</td><td style="text-align: center;">-</td></tr>';
							}
						}
					});
				});
				
				$("#" + targetDiv + " #flights").append(html);
			}
		</script>
		
		<style>
			table, th, td {
				border: 1px solid black;
				border-collapse: collapse;
				text-align: center;
			}
		</style>
	</head>

	<body>
		<div id="searchParams">
			<label for="origin">Origine</label>
			<select id="origin">
				<option value="BGY">Milano (Bergamo)</option>
				<option value="PMO">Palermo</option>
			</select>
			<br />
			<label for="destination">Destinazione</label>
			<select id="destination">
				<option value="PMO">Palermo</option>
				<option value="BGY">Milano (Bergamo)</option>
			</select>
			<br />
			<label for="dateOut">Data andata</label>
			<input id="dateOut" type="text" placeholder="es. 01/01/2017" />
			<br />
			<label for="dateIn">Data ritorno</label>
			<input id="dateIn" type="text" placeholder="es. 01/01/2017" />
			<br />
			<label for="weeksToScan">N. settimane da monitorare</label>
			<input id="weeksToScan" type="text" />
			<br />
			<label for="maxPrice">Prezzo massimo</label>
			<input id="maxPrice" type="text" placeholder="es. 20.00" />
			<br />
			<button type="button" onclick="retrieveFlightsData();">Cerca</button>
		</div>
		
		<div id="flightsOut">
			<span style="font-weight: bold;"><span id="origin"></span> - <span id="destination"></span>
			<table id="flights">
			</table>
		</div>
		
		<br />
		
		<div id="flightsBack">
			<span style="font-weight: bold;"><span id="origin"></span> - <span id="destination"></span>
			<table id="flights">
			</table>
		</div>
		
		<script>
			function retrieveFlightsData(){
				var origin = $("#searchParams #origin").val();
				var originName = $( "#searchParams #origin option:selected" ).text();
				var destination = $("#searchParams #destination").val();
				var destinationName = $( "#searchParams #destination option:selected" ).text();
				var weeksToScan = parseInt($("#searchParams #weeksToScan").val());
				var maxPrice = parseFloat($("#searchParams #maxPrice").val());
				
				$("#flightsOut #flights").html("");
				$("#flightsOut #flights").html("<tr><th>Data</th><th>Ora partenza</th><th>Ora arrivo</th><th>Volo</th><th>Prezzo (Standard)</th><th>Prezzo (Leisure)</th><th>Prezzo (Business)</th></tr>");
				$("#flightsBack #flights").html("");
				$("#flightsBack #flights").html("<tr><th>Data</th><th>Ora partenza</th><th>Ora arrivo</th><th>Volo</th><th>Prezzo (Standard)</th><th>Prezzo (Leisure)</th><th>Prezzo (Business)</th></tr>");
				
				$("#flightsOut #origin").html(originName + " (" + origin + ")");
				$("#flightsOut #destination").html(destinationName + " (" + destination + ")");
				$("#flightsBack #origin").html(destinationName + " (" + destination + ")");
				$("#flightsBack #destination").html(originName + " (" + origin + ")");
				
				for(var i = 0; i < weeksToScan; i++){
					var dateOut = moment($("#searchParams #dateOut").val(), "DD/MM/YYYY").add(i*7, 'days').format('YYYY-MM-DD');
					var dateIn = moment($("#searchParams #dateIn").val(), "DD/MM/YYYY").add(i*7, 'days').format('YYYY-MM-DD');
					/*$.get("https://desktopapps.ryanair.com/it-it/availability?ADT=1&CHD=0&DateIn=" + dateIn + "&DateOut=" + dateOut + "&Destination=" + destination + "&FlexDaysIn=6&FlexDaysOut=6&INF=0&Origin=" + origin + "&RoundTrip=true&TEEN=0&exists=false", function(flightsData) {
						var trips = flightsData.trips;
						
						handleTrip(trips[0], "flightsOut", maxPrice);
						handleTrip(trips[1], "flightsBack", maxPrice);
					});*/
					
					$.ajax({
						type: "GET",
						url: "https://desktopapps.ryanair.com/it-it/availability?ADT=1&CHD=0&DateIn=" + dateIn + "&DateOut=" + dateOut + "&Destination=" + destination + "&FlexDaysIn=6&FlexDaysOut=6&INF=0&Origin=" + origin + "&RoundTrip=true&TEEN=0&exists=false",
						async: false
					}).done(function(flightsData) {
						var trips = flightsData.trips;
						
						handleTrip(trips[0], "flightsOut", maxPrice);
						handleTrip(trips[1], "flightsBack", maxPrice);
					});
				}
			}
		</script>
		
	</body>

</html>